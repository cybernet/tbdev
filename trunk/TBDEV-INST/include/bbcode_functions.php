<?php
$smilies = array(
  ":-)" => "smile1.gif",
  ":smile:" => "smile2.gif",
  ":-D" => "grin.gif",
  ":lol:" => "laugh.gif",
  ":w00t:" => "w00t.gif",
  ":-P" => "tongue.gif",
  ";-)" => "wink.gif",
  ":-|" => "noexpression.gif",
  ":-/" => "confused.gif",
  ":-(" => "sad.gif",
  ":'-(" => "cry.gif",
  ":weep:" => "weep.gif",
  ":-O" => "ohmy.gif",
  ":o)" => "clown.gif",
  "8-)" => "cool1.gif",
  "|-)" => "sleeping.gif",
  ":innocent:" => "innocent.gif",
  ":whistle:" => "whistle.gif",
  ":unsure:" => "unsure.gif",
  ":closedeyes:" => "closedeyes.gif",
  ":cool:" => "cool2.gif",
  ":fun:" => "fun.gif",
  ":thumbsup:" => "thumbsup.gif",
  ":thumbsdown:" => "thumbsdown.gif",
  ":blush:" => "blush.gif",
  ":unsure:" => "unsure.gif",
  ":yes:" => "yes.gif",
  ":no:" => "no.gif",
  ":love:" => "love.gif",
  ":?:" => "question.gif",
  ":!:" => "excl.gif",
  ":idea:" => "idea.gif",
  ":arrow:" => "arrow.gif",
  ":arrow2:" => "arrow2.gif",
  ":hmm:" => "hmm.gif",
  ":hmmm:" => "hmmm.gif",
  ":huh:" => "huh.gif",
  ":geek:" => "geek.gif",
  ":look:" => "look.gif",
  ":rolleyes:" => "rolleyes.gif",
  ":kiss:" => "kiss.gif",
  ":shifty:" => "shifty.gif",
  ":blink:" => "blink.gif",
  ":smartass:" => "smartass.gif",
  ":sick:" => "sick.gif",
  ":crazy:" => "crazy.gif",
  ":wacko:" => "wacko.gif",
  ":alien:" => "alien.gif",
  ":wizard:" => "wizard.gif",
  ":wave:" => "wave.gif",
  ":wavecry:" => "wavecry.gif",
  ":baby:" => "baby.gif",
  ":angry:" => "angry.gif",
  ":ras:" => "ras.gif",
  ":sly:" => "sly.gif",
  ":devil:" => "devil.gif",
  ":evil:" => "evil.gif",
  ":evilmad:" => "evilmad.gif",
  ":sneaky:" => "sneaky.gif",
  ":axe:" => "axe.gif",
  ":slap:" => "slap.gif",
  ":wall:" => "wall.gif",
  ":rant:" => "rant.gif",
  ":jump:" => "jump.gif",
  ":yucky:" => "yucky.gif",
  ":nugget:" => "nugget.gif",
  ":smart:" => "smart.gif",
  ":shutup:" => "shutup.gif",
  ":shutup2:" => "shutup2.gif",
  ":crockett:" => "crockett.gif",
  ":zorro:" => "zorro.gif",
  ":snap:" => "snap.gif",
  ":beer:" => "beer.gif",
  ":beer2:" => "beer2.gif",
  ":drunk:" => "drunk.gif",
  ":strongbench:" => "strongbench.gif",
  ":weakbench:" => "weakbench.gif",
  ":dumbells:" => "dumbells.gif",
  ":music:" => "music.gif",
  ":stupid:" => "stupid.gif",
  ":dots:" => "dots.gif",
  ":offtopic:" => "offtopic.gif",
  ":spam:" => "spam.gif",
  ":oops:" => "oops.gif",
  ":lttd:" => "lttd.gif",
  ":please:" => "please.gif",
  ":sorry:" => "sorry.gif",
  ":hi:" => "hi.gif",
  ":yay:" => "yay.gif",
  ":cake:" => "cake.gif",
  ":hbd:" => "hbd.gif",
  ":band:" => "band.gif",
  ":punk:" => "punk.gif",
	":rofl:" => "rofl.gif",
  ":bounce:" => "bounce.gif",
  ":mbounce:" => "mbounce.gif",
  ":thankyou:" => "thankyou.gif",
  ":gathering:" => "gathering.gif",
  ":hang:" => "hang.gif",
  ":chop:" => "chop.gif",
  ":rip:" => "rip.gif",
  ":whip:" => "whip.gif",
  ":judge:" => "judge.gif",
  ":chair:" => "chair.gif",
  ":tease:" => "tease.gif",
  ":box:" => "box.gif",
  ":boxing:" => "boxing.gif",
  ":guns:" => "guns.gif",
  ":shoot:" => "shoot.gif",
  ":shoot2:" => "shoot2.gif",
  ":flowers:" => "flowers.gif",
  ":wub:" => "wub.gif",
  ":lovers:" => "lovers.gif",
  ":kissing:" => "kissing.gif",
  ":kissing2:" => "kissing2.gif",
  ":console:" => "console.gif",
  ":group:" => "group.gif",
  ":hump:" => "hump.gif",
  ":hooray:" => "hooray.gif",
  ":happy2:" => "happy2.gif",
  ":clap:" => "clap.gif",
  ":clap2:" => "clap2.gif",
	":weirdo:" => "weirdo.gif",
  ":yawn:" => "yawn.gif",
  ":bow:" => "bow.gif",
	":dawgie:" => "dawgie.gif",
	":cylon:" => "cylon.gif",
  ":book:" => "book.gif",
  ":fish:" => "fish.gif",
  ":mama:" => "mama.gif",
  ":pepsi:" => "pepsi.gif",
  ":medieval:" => "medieval.gif",
  ":rambo:" => "rambo.gif",
  ":ninja:" => "ninja.gif",
  ":hannibal:" => "hannibal.gif",
  ":party:" => "party.gif",
  ":snorkle:" => "snorkle.gif",
  ":evo:" => "evo.gif",
  ":king:" => "king.gif",
  ":chef:" => "chef.gif",
  ":mario:" => "mario.gif",
  ":pope:" => "pope.gif",
  ":fez:" => "fez.gif",
  ":cap:" => "cap.gif",
  ":cowboy:" => "cowboy.gif",
  ":pirate:" => "pirate.gif",
  ":pirate2:" => "pirate2.gif",
  ":rock:" => "rock.gif",
  ":cigar:" => "cigar.gif",
  ":icecream:" => "icecream.gif",
  ":oldtimer:" => "oldtimer.gif",
	":trampoline:" => "trampoline.gif",
	":banana:" => "bananadance.gif",
  ":smurf:" => "smurf.gif",
  ":yikes:" => "yikes.gif",
  ":osama:" => "osama.gif",
  ":saddam:" => "saddam.gif",
  ":santa:" => "santa.gif",
  ":indian:" => "indian.gif",
  ":pimp:" => "pimp.gif",
  ":nuke:" => "nuke.gif",
  ":jacko:" => "jacko.gif",
  ":ike:" => "ike.gif",
  ":greedy:" => "greedy.gif",
	":super:" => "super.gif",
  ":wolverine:" => "wolverine.gif",
  ":spidey:" => "spidey.gif",
  ":spider:" => "spider.gif",
  ":bandana:" => "bandana.gif",
  ":construction:" => "construction.gif",
  ":sheep:" => "sheep.gif",
  ":police:" => "police.gif",
	":detective:" => "detective.gif",
  ":bike:" => "bike.gif",
	":fishing:" => "fishing.gif",
  ":clover:" => "clover.gif",
  ":horse:" => "horse.gif",
  ":shit:" => "shit.gif",
  ":soldiers:" => "soldiers.gif",
  ":blum:" => "blum.gif",
  ":congrat:" => "clapping2.gif",
  ":thedevil:" => "diablo.gif",
  ":drinks2:" => "drinks2.gif",
  ":rose:" => "give_rose.gif",
  ":good:" => "good.gif",
  ":hi2:" => "hi2.gif",
  ":pardon:" => "pardon.gif",
  ":rofl2:" => "rofl2.gif",
  ":spite:" => "spiteful.gif",
  ":unsure:" => "unknw.gif",
);



$privatesmilies = array(
  ":)" => "smile1.gif",
//  ";)" => "wink.gif",
  ":wink:" => "wink.gif",
  ":D" => "grin.gif",
  ":P" => "tongue.gif",
  ":(" => "sad.gif",
  ":'(" => "cry.gif",
  ":|" => "noexpression.gif",
  // "8)" => "cool1.gif",   we don't want this as a smilie...
  ":Boozer:" => "alcoholic.gif",
  ":deadhorse:" => "deadhorse.gif",
  ":spank:" => "spank.gif",
  ":yoji:" => "yoji.gif",
  ":locked:" => "locked.gif",
  ":grrr:" => "angry.gif", 			// legacy
  "O:-" => "innocent.gif",			// legacy
  ":sleeping:" => "sleeping.gif",	// legacy
  "-_-" => "unsure.gif",			// legacy
  ":clown:" => "clown.gif",
  ":mml:" => "mml.gif",
  ":rtf:" => "rtf.gif",
  ":morepics:" => "morepics.gif",
  ":rb:" => "rb.gif",
  ":rblocked:" => "rblocked.gif",
  ":maxlocked:" => "maxlocked.gif",
  ":hslocked:" => "hslocked.gif",
); 

$customsmilies = array(  
   ":fart:" => "fart.gif",
  ":fart2:" => "fart2.gif",
  ":lurker:" => "lurker.gif",
  ":blow:" => "badrazz.gif",
  ":jawdrop:" => "jawdrop.gif",
  ":sob:" => "sob.gif",
  ":whip2:" => "whip2.gif",
  ":geek2:" => "geek2.gif",
  ":madgrin:" => "mad-grin.gif",
  ":byebye:" => "connie_mini_byebye.gif",
  ":badrazz:" => "badrazz.gif",
  ":img:" => "img.gif",
  ":alcohol:" => "alcohol.gif",
  ":pmsl:" => "hysterical.gif",
  ":bombie:" => "bomb_ie.gif",
  ":whoops:" => "whoops.gif",
  ":banned:" => "banned.gif",
  ":faq:" => "faq.gif",
  ":iluvff:" => "iluvff.gif",
  ":starwars:" => "starwars.gif",
  ":mage:" => "mage.gif",
  ":respect:" => "respect.gif",
  ":utorrent:" => "utorrent.gif",
  ":spliffy:" => "spliffy.gif",
  ":bear:" => "bear.gif",
  ":bandit:" => "bandit.gif",
  ":congrats:" => "congrats.gif",
  ":smokin:" => "smokin.gif",
  ":canabis:" => "canabis.gif",
  ":2gun:" => "2gun.gif",
  ":bigun:" => "biggun.gif",
  ":chainsaw:" => "chainsaw2.gif",
  ":drinks:" => "drinks.gif",
  ":fight1:" => "fight1.gif",
  ":fight2:" => "fight2.gif",
  ":fight3:" => "fight3.gif",
  ":fight4:" => "fight4.gif",
  ":first:" => "first.gif",
  ":fight1:" => "fight1.gif",
  ":Gotcha:" => "Gotcha.gif",
  ":jumping:" => "jumping.gif",
  ":yoda:" => "yoda.gif",
  ":wink1:" => "wink1.gif",
  ":upyours:" => "upyours.gif",
  ":taz:" => "taz.gif",
  ":spew2:" => "spew2.gif",
  ":spew:" => "spew.gif",
  ":sniper1:" => "sniper1.gif",
  ":smokie2:" => "smokie2.gif",
  ":sick2:" => "sick2.gif",
  ":scream:" => "scream.gif",
  ":rasp2:" => "rasp2.gif",
  ":rasp:" => "rasp.gif",
  ":party8:" => "party8.gif",
  ":party7:" => "party7.gif", 
  ":party6:" => "party6.gif",
  ":party5:" => "party5.gif",
  ":party4:" => "party4.gif",
  ":party3:" => "party3.gif",
  ":party2:" => "party2.gif",
  ":party1:" => "party1.gif",
  ":oldman:" => "oldman.gif",
  ":ninja2:" => "ninja2.gif",
  ":madaRse:" => "madarse.gif",
  ":line:" => "Line.gif",
  ":last:" => "last.gif",
  ":kenny:" => "kenny.gif",
  ":jumping3:" => "jumping3.gif",
  ":jumping2:" => "jumping2.gif",
  ":jumping1:" => "jumping1.gif",
  ":pish:" => "pish.gif",
  ":grim:" => "grim.gif",
  ":taz2:" => "taz2.gif",
  ":spiderman:" => "spidey.gif",
  ":bong:" => "bong.gif",
  ":eye:" => "eye.gif",
  ":tumble:" => "tumbleweed.gif",
  ":welcome:" => "welcome.gif",
  ":fart3:" => "fart3.gif",
  );
$badwords = array("asshole" => "<img src=pic/censored.png>",
"Assshole" => "<img src=pic/censored.png>",
"ASSHOLE" => "<img src=pic/censored.png>",
"Fuck" => "<img src=pic/censored.png>",
"FUCK" => "<img src=pic/censored.png>",
"Cunt" => "<img src=pic/censored.png>",
"CUNT" => "<img src=pic/censored.png>",
"Bastard" => "<img src=pic/censored.png>",   
"BASTARD" => "<img src=pic/censored.png>",
"fcuk" => "<img src=pic/censored.png>",
"fook" => "<img src=pic/censored.png>",
"tosser" => "<img src=pic/censored.png>",
"Tosser" => "<img src=pic/censored.png>",
"fcck" => "<img src=pic/censored.png>",
"cnut" => "<img src=pic/censored.png>",
"Bollocks" => "<img src=pic/censored.png>",
"bollocks" => "<img src=pic/censored.png>",
"fucker" => "<img src=pic/censored.png>",
"Fucker" => "<img src=pic/censored.png>",
"Cunty" => "<img src=pic/censored.png>",
"cunty" => "<img src=pic/censored.png>",
"arseholes" => "<img src=pic/censored.png>",
"Arseholes" => "<img src=pic/censored.png>",
"Fuckwit" => "<img src=pic/censored.png>",
"fuckwit" => "<img src=pic/censored.png>",
"Shithead" => "<img src=pic/censored.png>",
"shithead" => "<img src=pic/censored.png>",
"Fuckface" => "<img src=pic/censored.png>",
"Motherfucker" => "<img src=pic/censored.png>",
"motherfucker" => "<img src=pic/censored.png>",
"Cock" => "<img src=pic/censored.png>",
"cock" => "<img src=pic/censored.png>",
"cocksucker" => "<img src=pic/censored.png>",
"shag" => "<img src=pic/censored.png>",
"WHORE" => "<img src=pic/censored.png>",
"dickhead" => "<img src=pic/censored.png>",
"Dickhead" => "<img src=pic/censored.png>",
"prick" => "<img src=pic/censored.png>",
"Prick" => "<img src=pic/censored.png>",
"faggot" => "<img src=pic/censored.png>",
"Faggot" => "<img src=pic/censored.png>",
"Crack" => "<img src=pic/censored.png>",
"Serial" => "<img src=pic/censored.png>",
"Keygen" => "<img src=pic/censored.png>",
"TiT" => "<img src=pic/censored.png>",
"Tit" => "<img src=pic/censored.png>",
"cvnt" => "<img src=pic/censored.png>",
"bar steward" => "<img src=pic/censored.png>",
"piss" => "<img src=pic/censored.png>",
"PISS" => "<img src=pic/censored.png>",
"FANNY" => "<img src=pic/censored.png>",
"Fanny" => "<img src=pic/censored.png>",
"fanny" => "<img src=pic/censored.png>",
"Bitch" => "<img src=pic/censored.png>",
"bitch" => "<img src=pic/censored.png>",
"Arse" => "<img src=pic/censored.png>",
"arse" => "<img src=pic/censored.png>",
"Fuckin" => "<img src=pic/censored.png>",
"fuckin" => "<img src=pic/censored.png>",
"fucking" => "<img src=pic/censored.png>",
"Fucking" => "<img src=pic/censored.png>",
"fuckface" => "<img src=pic/censored.png>",
"knob head" => "<img src=pic/censored.png>",
"fuckhead" => "<img src=pic/censored.png>",
"knob end" => "<img src=pic/censored.png>",
"fuck" => "<img src=pic/censored.png>",
"cunt" => "<img src=pic/censored.png>",
"Twat" => "<img src=pic/censored.png>",
"twat" => "<img src=pic/censored.png>",
"wanker" => "<img src=pic/censored.png>",
"bastard" => "<img src=pic/censored.png>",
"shit" => "<img src=pic/censored.png>",
"fvck" => "<img src=pic/censored.png>",
"Hoe" => "<img src=pic/censored.png>",
"FOOKIN" => "<img src=pic/censored.png>",
"FOOKING" => "<img src=pic/censored.png>",
"FOOK" => "<img src=pic/censored.png>",
"Ass" => "<img src=pic/censored.png>",
"ass wipe" => "<img src=pic/censored.png>",
"ass wipes" =>"<img src=pic/censored.png>",
);

//Finds last occurrence of needle in haystack
//in PHP5 use strripos() instead of this
function _strlastpos ($haystack, $needle, $offset = 0)
{
	$addLen = strlen ($needle);
	$endPos = $offset - $addLen;
	while (true)
	{
		if (($newPos = strpos ($haystack, $needle, $endPos + $addLen)) === false) break;
		$endPos = $newPos;
	}
	return ($endPos >= 0) ? $endPos : false;
}

function format_quotes($s)
{
  while ($old_s != $s)
  {
  	$old_s = $s;

	  //find first occurrence of [/quote]
	  $close = strpos($s, "[/quote]");
	  if ($close === false)
	  	return $s;

	  //find last [quote] before first [/quote]
	  //note that there is no check for correct syntax
	  $open = _strlastpos(substr($s,0,$close), "[quote");
	  if ($open === false)
	    return $s;

	  $quote = substr($s,$open,$close - $open + 8);

	  //[quote]Text[/quote]
	  $quote = preg_replace(
	    "/\[quote\]\s*((\s|.)+?)\s*\[\/quote\]\s*/i",
	    "<p class=sub><b>Quote:</b></p><table class=main border=1 cellspacing=0 cellpadding=10><tr><td style='border: 1px black dotted'>\\1</td></tr></table><br>", $quote);

	  //[quote=Author]Text[/quote]
	  $quote = preg_replace(
	    "/\[quote=(.+?)\]\s*((\s|.)+?)\s*\[\/quote\]\s*/i",
	    "<p class=sub><b>\\1 wrote:</b></p><table class=main border=1 cellspacing=0 cellpadding=10><tr><td style='border: 1px black dotted'>\\2</td></tr></table><br>", $quote);

	  $s = substr($s,0,$open) . $quote . substr($s,$close + 8);
  }

	return $s;
}

function format_comment($text, $strip_html = true)
{
	global $smilies, $privatesmilies, $pic_base_url, $customsmilies, $CURUSER, $badwords;

	$s = $text;

  // This fixes the extraneous ;) smilies problem. When there was an html escaped
  // char before a closing bracket - like >), "), ... - this would be encoded
  // to &xxx;), hence all the extra smilies. I created a new :wink: label, removed
  // the ;) one, and replace all genuine ;) by :wink: before escaping the body.
  // (What took us so long? :blush:)- wyz

	$s = str_replace(";)", ":wink:", $s);
	
	if ($strip_html)
		$s = htmlspecialchars($s);
    
	// [*]
	$s = preg_replace("/\[\*\]/", "<li>", $s);

	// [b]Bold[/b]
	$s = preg_replace("/\[b\]((\s|.)+?)\[\/b\]/", "<b>\\1</b>", $s);

	// [i]Italic[/i]
	$s = preg_replace("/\[i\]((\s|.)+?)\[\/i\]/", "<i>\\1</i>", $s);

	// [u]Underline[/u]
	$s = preg_replace("/\[u\]((\s|.)+?)\[\/u\]/", "<u>\\1</u>", $s);

	// [u]Underline[/u]

     // the [you] tag
    $s = preg_replace("/\[you\]/i", $CURUSER['username'], $s);
	
    // Dynamic Vars
    $s = dynamic_user_vars($s); 

    $s = preg_replace("/\[u\]((\s|.)+?)\[\/u\]/i", "<u>\\1</u>", $s);
         
    $s = preg_replace( "#\[img\](.+?)\[/img\]#ie", "check_image('\\1')", $s );

    $s = preg_replace("/\[img\](http:\/\/[^\s'\"<>]+(\.(jpg|gif|png)))\[\/img\]/i", "<IMG border=\"0\" src=\"\\1\">", $s);
        
    $s = preg_replace("/\[img=(http:\/\/[^\s'\"<>]+(\.(gif|jpg|png)))\]/i", "<IMG border=\"0\" src=\"\\1\">", $s);
  
    // Video tag [video=url]
    // YouTube Vids
    $s = preg_replace("/\[video=[^\s'\"<>]*youtube.com.*v=([^\s'\"<>]+)\]/ims", "<object width=\"500\" height=\"410\"><param name=\"movie\" value=\"http://www.youtube.com/v/\\1\"></param><embed src=\"http://www.youtube.com/v/\\1\" type=\"application/x-shockwave-flash\" width=\"500\" height=\"410\"></embed></object>", $s);
    // Google Vids
    $s = preg_replace("/\[video=[^\s'\"<>]*video.google.com.*docid=(-?[0-9]+).*\]/ims", "<embed style=\"width:500px; height:410px;\" id=\"VideoPlayback\" align=\"middle\" type=\"application/x-shockwave-flash\" src=\"http://video.google.com/googleplayer.swf?docId=\\1\" allowScriptAccess=\"sameDomain\" quality=\"best\" bgcolor=\"#ffffff\" scale=\"noScale\" wmode=\"window\" salign=\"TL\"  FlashVars=\"playerMode=embedded\"> </embed>", $s);

    // [highlight]Highlight text[/highlight]
    $s = preg_replace("/\[highlight\]((\s|.)+?)\[\/highlight\]/", "<table border=0 cellspacing=0 cellpadding=1>".

    
                                                                                  "<tr><td bgcolor=green><b>\\1</b></td></tr>".
                                                                                    "</table>", $s);


// [ codebox2]Some long text[/codebox2 ]
        $s = preg_replace(
    '/\[codebox\]\s*((\s|.)+?)\s*\[\/codebox\]\s*/i',
    '<div class="codetop">CODEBOX</div><div class="codemain" style="OVERFLOW: auto; WHITE-SPACE: pre; width: 100%; HEIGHT: 200px">\\1</div>', $s );

// [ code]Some long text[/code ]
        $s = preg_replace(
    '/\[code\]\s*((\s|.)+?)\s*\[\/code\]\s*/i',
    '<div class="codetop">CODE</div><div class="codemain" style="OVERFLOW: auto; WHITE-SPACE: pre; width: 100%; HEIGHT: 200px">\\1</div>', $s );

// [php]php code[/php]
$s = preg_replace( "/\[php\]((\s|.)+?)\[\/php\]/ise", "'<div class=\"codetop\">PHP</div><div class=\"codemain\">'.php(htmlspecialchars2('\\1')).'</div>'", $s );

// [html]html code[/html]

$s = preg_replace( "/\[html\]((\s|.)+?)\[\/html\]/ise", "'<div class=\"codetop\">HTML</div><div class=\"codemain\">'.highlight_html('\\1').'</div>'", $s );

// [s]Stroke[/s]
$s = preg_replace("/\[s\]((\s|.)+?)\[\/s\]/", "<s>\\1</s>", $s);

// [sql]Bold[/sql]

$s = preg_replace( "/\[sql\]((\s|.)+?)\[\/sql\]/ise", "''.highlight_sql(htmlspecialchars2('\\1')).''", $s );

  // [marquee]Marquee[/marquee]
    $s = preg_replace("/\[marquee\]((\s|.)+?)\[\/marquee\]/", "<marquee>\\1</marquee>", $s);

    // [blink]blink[/blink]
    $s = preg_replace("/\[blink\]((\s|.)+?)\[\/blink\]/", "<blink>\\1</blink>", $s);

    // [mcom]Text[/mcom]
   $s = preg_replace(
   "/\[mcom\]\s*((\s|.)+?)\s*\[\/mcom\]\s*/i",
   "<span style=\"font-size: 18pt; line-height: 50%;\">
   <div style=\"border-color: red; background-color: red; color: white; text-align: center; font-weight: bold; font-size: large;\">
   <b>\\1</b>
   </div>
   </span>", $s); 
   
   // [audio].mp3[/audio]
   $s = preg_replace(
   "/\[audio\]([^()<>\s]+?)\[\/audio\]/i",
   "<object type='application/x-shockwave-flash' data='flashplayer.swf' width='200' height='55'>
   <param name='movie' value='flashplayer.swf?src=\\1'>
   <param name='quality' value='high'>
   </object>", $s);

   // [color=blue]Text[/color]
	$s = preg_replace(
		"/\[color=([a-zA-Z]+)\]((\s|.)+?)\[\/color\]/i",
		"<font color=\\1>\\2</font>", $s);

	// [color=#ffcc99]Text[/color]
	$s = preg_replace(
		"/\[color=(#[a-f0-9][a-f0-9][a-f0-9][a-f0-9][a-f0-9][a-f0-9])\]((\s|.)+?)\[\/color\]/i",
		"<font color=\\1>\\2</font>", $s);
   
        // [url=http://www.example.com]Text[/url]
        $s = preg_replace(
        "/\[url=([^()<>\s]+?)\]((\s|.)+?)\[\/url\]/i",
        "<a target=_blank href=redir.php?url=\\1>\\2</a>", $s);

// [url=http://www.example.com]Text[/url]
    $s = preg_replace(
        "/\[url=([^()<>\s]+?)\]((\s|.)+?)\[\/url\]/i",
        "<a target='_blank' href=\"\\1\">\\2 </a>", $s);

        // [url]http://www.example.com[/url]
       /*  $s = preg_replace(
        "/\[url\]([^()<>\s]+?)\[\/url\]/i",
        "<a target=_blank href=redir.php?url=\\1>\\1</a>", $s);*/


	// [size=4]Text[/size]
	$s = preg_replace(
		"/\[size=([1-7])\]((\s|.)+?)\[\/size\]/i",
		"<font size=\\1>\\2</font>", $s);
		
		

	// [font=Arial]Text[/font]
	$s = preg_replace(
		"/\[font=([a-zA-Z ,]+)\]((\s|.)+?)\[\/font\]/i",
		"<font face=\"\\1\">\\2</font>", $s);

//  //[quote]Text[/quote]
//  $s = preg_replace(
//    "/\[quote\]\s*((\s|.)+?)\s*\[\/quote\]\s*/i",
//    "<p class=sub><b>Quote:</b></p><table class=main border=1 cellspacing=0 cellpadding=10><tr><td style='border: 1px black dotted'>\\1</td></tr></table><br>", $s);

//  //[quote=Author]Text[/quote]
//  $s = preg_replace(
//    "/\[quote=(.+?)\]\s*((\s|.)+?)\s*\[\/quote\]\s*/i",
//    "<p class=sub><b>\\1 wrote:</b></p><table class=main border=1 cellspacing=0 cellpadding=10><tr><td style='border: 1px black dotted'>\\2</td></tr></table><br>", $s);

	// Quotes
	$s = format_quotes($s);

	// URLs
	 $s = format_urls($s);
                //$s = format_local_urls($s);

	// Linebreaks
	$s = nl2br($s);

	// [pre]Preformatted[/pre]
	$s = preg_replace("/\[pre\]((\s|.)+?)\[\/pre\]/i", "<tt><nobr>\\1</nobr></tt>", $s);

	// [nfo]NFO-preformatted[/nfo]
	$s = preg_replace("/\[nfo\]((\s|.)+?)\[\/nfo\]/i", "<tt><nobr><font face='MS Linedraw' size=2 style='font-size: 10pt; line-height: " .
		"10pt'>\\1</font></nobr></tt>", $s);

	// Maintain spacing
	$s = str_replace("  ", " &nbsp;", $s);
           
                // [hr=xxx]/[hr=xxx%]/[hr=xxxpt]/[hr=xxxpx]
                $s = preg_replace(
                "/\[hr(\=([0-9]{1,4})(%|px|pt)?)\]/i",
                "<hr align=center width=\"\\1\" />", $s);
                // [hr]
                $s = str_replace ("[hr]", "<hr>", $s);
                // [center]
                $s = preg_replace("/\[center\]((\s|.)+?)\[\/center\]/i", "<div align='center'><tt><nobr><font face='Verdana' size=2 style='font-size: 10pt; line-height: " .
                "10pt'>\\1</font></nobr></tt></div>", $s);

	//[spoiler]Text[/spoiler]
                $s = preg_replace("/\[spoiler\]\s*((\s|.)+?)\s*\[\/spoiler\]\s*/i",
                "<div><strong>Spoiler:</strong> (select text to read)</div> <div class=\"spoiler\">\\1</div>", $s);
        
                // [s]Stroke[/s]
                $s = preg_replace("/\[s\]((\s|.)+?)\[\/s\]/", "<s>\\1</s>", $s);  
	             
	reset($smilies);
	while (list($code, $url) = each($smilies))
	$s = str_replace($code, "<img border=0 src=\"{$pic_base_url}smilies/{$url}\" alt=\"" . htmlspecialchars($code) . "\">", $s);

	reset($privatesmilies);
	while (list($code, $url) = each($privatesmilies))
	$s = str_replace($code, "<img border=0 src=\"{$pic_base_url}smilies/{$url}\">", $s);
     
     reset($badwords);
     while (list($code, $url) = each($badwords))
     $s = str_replace($code, "$url", $s);
     
     reset($customsmilies);
     while (list($code, $url) = each($customsmilies))
     $s = str_replace($code, "<img border=0 src=\"/pic/smilies/$url\" alt=\"" . htmlspecialchars($code) . "\">", $s);
	 return $s;
     }

//=== smilie function
function get_smile()
{
  global $CURUSER;
  return $CURUSER["smile_until"];
}

function textbbcode($form,$name,$content="") {
?>

<script language=javascript>
function SmileIT(smile,form,text){
document.forms[form].elements[text].value = document.forms[form].elements[text].value+" "+smile+" ";
document.forms[form].elements[text].focus();
}

function PopMoreSmiles(form,name) {
link='moresmiles.php?form='+form+'&text='+name
newWin=window.open(link,'moresmile','height=500,width=450,resizable=no,scrollbars=yes');
if (window.focus) {newWin.focus()}
}

//=== custom smilies
function PopCustomSmiles(form,name) {
link='moresmilies_custom.php?form='+form+'&text='+name
newWin=window.open(link,'moresmile','height=600,width=400,resizable=yes,scrollbars=yes');
if (window.focus) {newWin.focus()}
}

function PopMoreTags(form,name) {
link='moretags.php?form='+form+'&text='+name
newWin=window.open(link,'moresmile','height=500,width=775,resizable=no,scrollbars=yes');
if (window.focus) {newWin.focus()}
}


function BBTag(tag,s,text,form){
switch(tag)
{
case '[RED]':
if (document.forms[form].elements[s].value=="RED ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[color=red]";
document.forms[form].elements[s].value="RED*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/color]";
document.forms[form].elements[s].value="RED ";
}
break;
case '[ORANGE]':
if (document.forms[form].elements[s].value=="ORANGE ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[color=orange]";
document.forms[form].elements[s].value="ORANGE*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/color]";
document.forms[form].elements[s].value="ORANGE ";
}
break;
case '[YELLOW]':
if (document.forms[form].elements[s].value=="YELLOW ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[color=yellow]";
document.forms[form].elements[s].value="YELLOW*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/color]";
document.forms[form].elements[s].value="YELLOW ";
}
break;
case '[LIME GREEN]':
if (document.forms[form].elements[s].value=="LIME GREEN ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[color=green]";
document.forms[form].elements[s].value="LIME GREEN*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/color]";
document.forms[form].elements[s].value="LIME GREEN ";
}
break;
case '[PURPLE]':
if (document.forms[form].elements[s].value=="PURPLE ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[color=purple]";
document.forms[form].elements[s].value="PURPLE*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/color]";
document.forms[form].elements[s].value="PURPLE ";
}
break;
case '[PINK]':
if (document.forms[form].elements[s].value=="PINK ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[color=pink]";
document.forms[form].elements[s].value="PINK*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/color]";
document.forms[form].elements[s].value="PINK ";
}
break;
case '[WHITE]':
if (document.forms[form].elements[s].value=="WHITE ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[color=white]";
document.forms[form].elements[s].value="WHITE*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/color]";
document.forms[form].elements[s].value="WHITE ";
}
break;
case '[QUOTE]':
if (document.forms[form].elements[s].value=="QUOTE ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[quote]";
document.forms[form].elements[s].value="QUOTE*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/quote]";
document.forms[form].elements[s].value="QTE ";
}
break;
case '[IMAGE]':
if (document.forms[form].elements[s].value=="IMAGE ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[img]";
document.forms[form].elements[s].value="IMAGE*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/img]";
document.forms[form].elements[s].value="IMAGE ";
}
break;
case '[MARQUEE]':
if (document.forms[form].elements[s].value=="MARQUEE ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[marquee]";
document.forms[form].elements[s].value="MARQUEE*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/marquee]";
document.forms[form].elements[s].value="MARQUEE ";
}
break;
case '[HIGHLIGHT]':
if (document.forms[form].elements[s].value=="HIGHLIGHT ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[highlight]";
document.forms[form].elements[s].value="HIGHLIGHT*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/highlight]";
document.forms[form].elements[s].value="HIGHLIGHT ";
}
break;
case '[URL]':
if (document.forms[form].elements[s].value=="URL ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[url]";
document.forms[form].elements[s].value="URL*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/url]";
document.forms[form].elements[s].value="URL ";
}
break;
case '[*]':
if (document.forms[form].elements[s].value=="LIST ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[*]";
}
break;
case '[BOLD]':
if (document.forms[form].elements[s].value=="BOLD ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[b]";
document.forms[form].elements[s].value="BOLD*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/b]";
document.forms[form].elements[s].value="BOLD ";
}
break;
case '[ITALIC]':
if (document.forms[form].elements[s].value=="ITALIC ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[i]";
document.forms[form].elements[s].value="ITALIC*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/i]";
document.forms[form].elements[s].value="ITALIC ";
}
break;
case '[UNDERLINE]':
if (document.forms[form].elements[s].value=="UNDERLINE ")
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[u]";
document.forms[form].elements[s].value="UNDERLINE*";
}
else
{
document.forms[form].elements[text].value = document.forms[form].elements[text].value+"[/u]";
document.forms[form].elements[s].value="UNDERLINE ";
}
break;
}
document.forms[form].elements[text].focus();
}

</script>


<table width="650" style='margin: 3px' cellpadding="0" cellspacing="0">
<tr>
<td class=embedded colspan=2>
<table cellpadding="2" cellspacing="1">
<tr>
<!-- <td width="100">BBCODE TAGS</td>-->
<td class=embedded><input class=btn style="font-weight: bold;" type="button" name="bold" value="BOLD " onclick="javascript: BBTag('[BOLD]','bold','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn style="font-style: italic;" type="button" name="italic" value="ITALIC " onclick="javascript: BBTag('[ITALIC]','italic','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn style="text-decoration: underline;" type="button" name="underline" value="UNDERLINE " onclick="javascript: BBTag('[UNDERLINE]','underline','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="li" value="LIST " onclick="javascript: BBTag('[*]','li','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="quote" value="QUOTE " onclick="javascript: BBTag('[QUOTE]','quote','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="url" value="URL " onclick="javascript: BBTag('[URL]','url','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="img" value="IMAGE " onclick="javascript: BBTag('[IMAGE]','img','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="marquee" value="MARQUEE " onclick="javascript: BBTag('[MARQUEE]','marquee','<? echo $name; ?>','<? echo $form; ?>')" /></td>
</tr>


<tr>
<!-- <td width="100">FONT COLOR</td>-->
<td class=embedded><input class=btn type="button" name="red" value="RED " onclick="javascript: BBTag('[RED]','red','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="orange" value="ORANGE " onclick="javascript: BBTag('[ORANGE]','orange','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="yellow" value="YELLOW " onclick="javascript: BBTag('[YELLOW]','yellow','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="lime" value="LIME GREEN " onclick="javascript: BBTag('[LIME GREEN]','lime','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="purple" value="PURPLE " onclick="javascript: BBTag('[PURPLE]','purple','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="pink" value="PINK " onclick="javascript: BBTag('[PINK]','pink','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="white" value="WHITE " onclick="javascript: BBTag('[WHITE]','white','<? echo $name; ?>','<? echo $form; ?>')" /></td>
<td class=embedded><input class=btn type="button" name="highlight" value="HIGHLIGHT " onclick="javascript: BBTag('[HIGHLIGHT]','highlight','<? echo $name; ?>','<? echo $form; ?>')" /></td>
</tr>
</table>
</td>
</tr>
<tr>
<td class=embedded>
<textarea name="<? echo $name; ?>" rows="20" cols="102"><? echo $content; ?></textarea>
</td>
<td class=embedded>
<table cellpadding="3" cellspacing="1">
<?

global $smilies, $BASEURL;
while ((list($code, $url) = each($smilies)) && $count<32) {
if ($count % 4==0)
print("<tr>");

print("\n<td class=embedded style='padding: 3px; margin: 2px'><a href=\"javascript: SmileIT('".str_replace("'","\'",$code)."','$form','$name')\"><img border=0 src=pic/smilies/".$url."></a></td>");
$count++;

if ($count % 4==0)
print("</tr>");
}
?>
</table>
<center><a href="javascript: PopMoreSmiles('<? echo $form; ?>','<? echo $name; ?>')"><? echo Smilies;?></a></center>
<?php
if(get_smile() != '0000-00-00 00:00:00')
echo'<br><a class=altlink href="javascript: PopCustomSmiles(\''.$form.'\',\''.$name.'\')"><b>custom smilies</b></a>';
?>
</td>
</tr>
</table>
<?
}
function user_key_codes($key)
{
    return "/\[$key\]/i";
}

function dynamic_user_vars($text)
{
    global $CURUSER;
    // $zone = 0;        // GMT
    $zone = 3600*-5;    // EST
    $tim = time() + $zone;

    $cu=$CURUSER;
    // unset any variables ya dun want to display, or can't display
    unset($cu['old_password'],$cu['secret'],$cu['editsecret'],$cu['modcomment']);
    $bbkeys=array_keys($cu);
    $bbkeys[]='curdate';
    $bbkeys[]='curtime';
    $bbvals=array_values($cu);
    $bbvals[]=gmdate('F jS, Y',$tim);
    $bbvals[]=gmdate('g:i A',$tim);
    $bbkeys=array_map('user_key_codes',$bbkeys);
    return preg_replace($bbkeys,$bbvals,$text);
}
?>